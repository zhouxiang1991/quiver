{
  "title": "直接计算准确率",
  "cells": [
    {
      "type": "code",
      "language": "viml",
      "data": "db.getCollection('test_predication').aggregate([\n  {\n    $group: {\n      _id: {\n        uid: \"$uid\",\n        status: \"$status\"\n      },\n      count: {\n        $sum: 1\n      }\n    }\n  },\n  {\n    $project: {\n      status: '$_id.status',\n      count: 1,\n      uid: '$_id.uid',\n      _id: 0,\n      \n    }\n  },\n  {\n    $project: {\n      uid: \"$uid\",\n      arr: [\n        {\n          k: {\n            $substr: [\n              \"$status\",\n              0,\n              -1\n            ]\n          },\n          v: \"$count\"\n        }\n      ]\n    }\n  },\n  {\n    $project: {\n      uid: 1,\n      b: {\n        $arrayToObject: {\n          $map: {\n            input: \"$arr\",\n            as: \"pair\",\n            in: [\n              \"$$pair.k\",\n              \"$$pair.v\"\n            ]\n          }\n        }\n      }\n    }\n  },\n  {\n    $project: {\n      uid: 1,\n      \"100\": \"$b.100\",\n      \"201\": \"$b.201\",\n      \"202\": \"$b.202\",\n      \"199\": \"$b.199\",\n      \"200\": \"$b.200\",\n      \n    }\n  },\n  {\n    $group: {\n      _id: \"$uid\",\n      100: {\n        $sum: \"$100\"\n      },\n      201: {\n        $sum: \"$201\"\n      },\n      202: {\n        $sum: \"$202\"\n      },\n      199: {\n        $sum: \"$199\"\n      },\n      200: {\n        $sum: \"$200\"\n      },\n      \n    },\n    \n  },\n  {\n    $project: {\n      _id: 1,\n      rrr: {\n        $divide: [\n          {\n            $add: [\n              '$201',\n              '$199'\n            ],\n            \n          },\n          {\n            $add: [\n              '$201',\n              '$202',\n              '$199',\n              '$200'\n            ]\n          }\n        ]\n      },\n      201: 1,\n      202: 1,\n      199: 1,\n      200: 1,\n      rate: {\n        $divide: [\n          '$201',\n          {\n            $add: [\n              '$201',\n              '$202'\n            ]\n          }\n        ]\n      },\n      score: {\n        $divide: [\n          {\n            $add: [\n              {\n                $multiply: [\n                  '$200',\n                  -1\n                ]\n              },\n              {\n                $multiply: [\n                  '$199',\n                  1\n                ]\n              },\n              {\n                $multiply: [\n                  '$201',\n                  3\n                ]\n              },\n              {\n                $multiply: [\n                  '$202',\n                  -3\n                ]\n              },\n              \n            ]\n          },\n          {\n            $multiply: [\n              {\n                $add: [\n                  '$201',\n                  '$202',\n                  '$199',\n                  '$200'\n                ]\n              },\n              3\n            ]\n          }\n        ]\n      },\n      \n    },\n    \n  },\n  {\n    $sort: {\n      rate: -1,\n      //rrr: -1\n    }\n  }\n])\n"
    }
  ]
}